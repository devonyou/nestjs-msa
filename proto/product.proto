syntax = "proto3";

package product;

// import "google/protobuf/timestamp.proto";

service ProductService {
    // product
    rpc createProduct(CreateProductRequest) returns (ProductResponse);
    rpc getProducts(GetProductsRequest) returns (ProductListResponse);
    rpc getProductsByIds(GetProductsByIdsRequest) returns (ProductListResponse);
    rpc getProductById(GetProductByIdRequest) returns (ProductResponse);
    rpc updateProduct(UpdateProductRequest) returns (ProductResponse);
    rpc deleteProduct(DeleteProductRequest) returns (Empty);
    

    // category
    rpc createCategory(CreateCategoryRequest) returns (CategoryResponse);
    rpc getAllCategories(Empty) returns (CategoryListResponse);
    rpc getCategoryById(GetCategoryByIdRequest) returns (CategoryResponse);
    rpc updateCategory(UpdateCategoryRequest) returns (CategoryResponse);
    rpc deleteCategory(DeleteCategoryRequest) returns (Empty);

    // presigned url
    rpc generatePresignedUrl(GeneratePresignedUrlRequest) returns (GeneratePresignedUrlResponse);

    // stock
    rpc getStockByProductId(GetStockByProductIdRequest) returns (StockResponse);
    rpc upsertStock(UpsertStockQuantityRequest) returns (StockResponse);

    // stock reservation
    rpc createStockReservation(CreateStockReservationRequest) returns (StockReservationListResponse);
    rpc confirmStockReservation(ConfirmStockReservationRequest) returns (StockReservationListResponse);
    rpc restoreStockReservation(RestoreStockReservationRequest) returns (StockReservationListResponse);
}

// product

message Product {
    int32 id = 1;
    string name = 2;
    string description = 3;
    int32 price = 4;
    repeated ProductImage images = 5;
    Category category = 6;
}

message ProductImage {
    optional int32 id = 1;
    string url = 2;
    optional bool main = 3;
    optional int32 productId = 4;
}

message ProductResponse {
    int32 id = 1;
    string name = 2;
    string description = 3;
    int32 price = 4;
    repeated ProductImage images = 5;
    CategoryResponse category = 6;
    StockResponse stock = 7;
    string createdAt = 8;
    string updatedAt = 9;
}

message ProductListResponse {
    repeated ProductResponse products = 1;
    int32 total = 2;
}

message CreateProductRequest {
    string name = 1;
    string description = 2;
    int32 price = 3;
    int32 categoryId = 4;
    repeated ProductImage images = 5;
}

message GetProductsRequest {
    int32 page = 1;
    int32 limit = 2;
    string sort = 3;
    optional int32 categoryId = 4;
    optional string name = 5;
}

message GetProductsByIdsRequest {
    repeated int32 ids = 1;
}

message GetProductByIdRequest {
    int32 id = 1;
}

message UpdateProductRequest {
    int32 id = 1;
    optional string name = 2;
    optional string description = 3;
    optional int32 price = 4;
    optional int32 categoryId = 5;
    repeated ProductImage images = 6;
}

message DeleteProductRequest {
    int32 id = 1;
}

// category

message Category {
    int32 id = 1;
    string name = 2;
    optional string description = 3;
    optional int32 parentId = 4;
}

message CategoryResponse {
    int32 id = 1;
    string name = 2;
    string description = 3;
    optional Category parent = 4;
    repeated Category children = 5;
    repeated ProductResponse products = 6;
}

message CategoryListResponse {
    repeated CategoryResponse categories = 1;
}

message CreateCategoryRequest {
    string name = 1;
    optional string description = 2;
    optional int32 parentId = 3;
}

message UpdateCategoryRequest {
    int32 id = 1;
    optional string name = 2;
    optional string description = 3;
    optional int32 parentId = 4;
}

message DeleteCategoryRequest {
    int32 id = 1;
}

message GetCategoryByIdRequest {
    int32 id = 1;
}

// presigned url

message GeneratePresignedUrlRequest {
    string contentType = 1;
}

message GeneratePresignedUrlResponse {
    string presignedUrl = 1;
    string filename = 2;
    string fileUrl = 3;
    string filePath = 4;
}

// stock

message Stock {
    int32 id = 1;
    int32 quantity = 2;
    Product product = 3;
}

message StockResponse {
    int32 id = 1;
    int32 quantity = 2;
    ProductResponse product = 3;
}

enum ChangeType {
    IN = 0;
    OUT = 1;
    RESERVED = 2;
    CANCELLED = 3;
}

message GetStockByProductIdRequest {
    int32 productId = 1;
}

message UpsertStockQuantityRequest {
    int32 productId = 1;
    int32 quantity = 2;
}

// stock reservation

message StockReservation {
    int32 id = 1;
    int32 productId = 2;
    int32 reservedQty = 3;
    string expiresAt = 4;
    string orderId = 5;
    StockReservationStatus status = 6;
}

message StockReservationResponse {
    int32 id = 1;
    int32 productId = 2;
    int32 reservedQty = 3;
    string expiresAt = 4;
    string orderId = 5;
    StockReservationStatus status = 6;
}

message StockReservationListResponse {
    repeated StockReservationResponse reservations = 1;
}

message CreateStockReservation {
    int32 productId = 1;
    int32 reservedQty = 2;
}

message CreateStockReservationRequest {
    repeated CreateStockReservation reservations = 1;
    string orderId = 2;
}

message ConfirmStockReservationRequest {
    string orderId = 1;
}

message RestoreStockReservationRequest {
    string orderId = 1;
}

message Empty {}

enum StockReservationStatus {
    PENDING = 0;
    CONFIRMED = 1;
    RELEASED = 2;
    EXPIRED = 3;
}